# 项目待办事项清单 (TODO List)

**项目**: 工业机床数据采集网关  
**当前版本**: v1.0 - Ubuntu 22.04 arm64 测试版  
**目标版本**: v2.0 - FriendlyWRT 生产版  
**更新日期**: 2025-10-10

---

## 📌 优先级说明

- 🔴 **P0 - 紧急** ：生产部署必须完成
- 🟠 **P1 - 高** ：核心功能，近期完成
- 🟡 **P2 - 中** ：重要功能，计划中
- 🟢 **P3 - 低** ：锦上添花，有时间再做

---

## 🎯 阶段一: 当前 Ubuntu 测试版完善 (2-3 周)

### 🔴 P0 - 实际设备对接（必须）

- [ ] **连接实际测厚仪设备**
  - [ ] 获取测厚仪技术手册和通信协议文档
  - [ ] 确认通信参数（波特率、数据位、校验位）
  - [ ] 确认数据帧格式（帧头、数据、CRC、帧尾）
  - [ ] 购买或准备 USB-RS485 转换器（CH340/FT232芯片）
  - [ ] 物理连接：R5S USB → RS485转换器 → 测厚仪

- [ ] **修改 rs485d 通信协议**
  - [ ] 修改 `src/rs485d/main.cpp` 中的 `query_thickness()` 函数
  - [ ] 实现正确的查询命令构造
  - [ ] 实现正确的响应解析
  - [ ] 实现 CRC 校验（如果协议需要）
  - [ ] 删除模拟数据生成代码
  - [ ] 添加协议文档到 `docs/` 目录

- [ ] **数据准确性验证**
  - [ ] 使用标准厚度样板进行测试
  - [ ] 对比测厚仪显示值和网关读取值
  - [ ] 记录误差范围（目标: ±0.01mm）
  - [ ] 长时间稳定性测试（至少 24 小时）

### 🟠 P1 - 核心功能完善

- [ ] **Web 界面完善**
  - [ ] 实现 POST /api/config 配置更新功能
  - [ ] 实现配置 60 秒回滚机制
    - [ ] 临时应用新配置
    - [ ] 60 秒倒计时，用户确认
    - [ ] 未确认则自动回滚
  - [ ] 添加配置验证（合法性检查）
  - [ ] 添加重启服务功能
  - [ ] 添加历史数据查看（最近 100 条）
  - [ ] 优化前端界面（图表、趋势）

- [ ] **错误处理和恢复**
  - [ ] 串口设备断开自动重连
  - [ ] 共享内存异常处理
  - [ ] Modbus 连接异常处理
  - [ ] 配置文件损坏恢复
  - [ ] 添加重试机制和退避策略

- [ ] **日志系统完善**
  - [ ] 实现 logrotate 配置（按天轮转，保留 7 天）
  - [ ] 添加日志级别配置（可动态调整）
  - [ ] 添加关键事件审计日志
  - [ ] 日志文件大小限制（单个文件 10MB）

- [ ] **性能监控**
  - [ ] 添加 Prometheus metrics 导出（可选）
  - [ ] 实时性能指标：CPU、内存、延迟
  - [ ] 数据更新频率监控
  - [ ] 错误率告警（超过 5% 时）

### 🟡 P2 - 测试和文档

- [ ] **单元测试**
  - [ ] 为 NDM 数据模型编写测试
  - [ ] 为环形缓冲区编写测试
  - [ ] 为配置管理编写测试
  - [ ] 为 CRC 计算编写测试
  - [ ] 使用 Google Test 框架

- [ ] **集成测试**
  - [ ] 端到端测试（rs485d → modbusd → 客户端）
  - [ ] 压力测试（高频读写）
  - [ ] 长稳测试（7×24 小时）
  - [ ] 异常场景测试（断网、掉电、设备拔插）

- [ ] **性能基准测试**
  - [ ] Modbus TCP 吞吐量测试（TPS）
  - [ ] Modbus TCP 响应延迟测试（P50/P99）
  - [ ] RS-485 采样频率准确性测试
  - [ ] 内存泄漏检测（valgrind）
  - [ ] CPU 占用率测试

- [ ] **文档完善**
  - [ ] 编写 API 文档（Doxygen 生成）
  - [ ] 编写协议适配手册（如何对接不同测厚仪）
  - [ ] 编写故障排查手册
  - [ ] 编写运维手册
  - [ ] 添加架构图和时序图

---

## 🚀 阶段二: FriendlyWRT 移植 (3-4 周)

### 🔴 P0 - 交叉编译环境

- [ ] **搭建交叉编译工具链**
  - [ ] 在 Ubuntu x86_64 主机上安装 aarch64-linux-gnu-gcc
  - [ ] 下载 FriendlyWRT SDK
  - [ ] 配置 CMake toolchain 文件
  - [ ] 编译依赖库（libmodbus、jsoncpp）
  - [ ] 测试交叉编译可执行文件

- [ ] **交叉编译网关程序**
  - [ ] 修改 CMakeLists.txt 支持交叉编译
  - [ ] 编译静态链接版本（减少依赖）
  - [ ] 优化可执行文件大小（strip、upx）
  - [ ] 验证在 R5S 上可运行

### 🟠 P1 - FriendlyWRT 适配

- [ ] **系统配置**
  - [ ] 创建 `/opt/gw/` 目录结构
  - [ ] 配置只读根文件系统 + overlay
  - [ ] 配置 eMMC 分区（boot / root / overlay / data）
  - [ ] 配置网络（eth0、eth1）
  - [ ] 配置 udev 规则（USB 设备自动识别）

- [ ] **OpenWrt 服务脚本**
  - [ ] 将 systemd 服务转换为 procd init 脚本
  - [ ] 编写 `/etc/init.d/gw-rs485d`
  - [ ] 编写 `/etc/init.d/gw-modbusd`
  - [ ] 编写 `/etc/init.d/gw-webcfg`
  - [ ] 配置开机自启和服务依赖

- [ ] **固件打包**
  - [ ] 编写 Makefile 打包为 ipk 包
  - [ ] 集成到 FriendlyWRT 固件构建系统
  - [ ] 制作完整固件镜像（.img）
  - [ ] 编写烧录脚本和说明

### 🟡 P2 - 生产优化

- [ ] **性能优化**
  - [ ] CPU 亲和性绑定（rs485d 绑定到 CPU0）
  - [ ] 实时调度策略（SCHED_FIFO）
  - [ ] 中断亲和性调整
  - [ ] 内核参数调优（sysctl）
  - [ ] 禁用不必要的系统服务

- [ ] **可靠性增强**
  - [ ] 实现看门狗守护进程
  - [ ] 添加掉电检测（GPIO）
  - [ ] 实现紧急数据保存
  - [ ] 配置文件完整性校验（SHA256）
  - [ ] 双分区 A/B 升级机制

- [ ] **远程管理**
  - [ ] 实现固件 OTA 升级（HTTP/TFTP）
  - [ ] 添加 SSH 远程访问
  - [ ] 添加远程日志收集
  - [ ] 添加性能监控上报

---

## 🔧 阶段三: 协议扩展 (4-6 周)

### 🟠 P1 - S7 客户端支持

- [ ] **S7 通信模块开发**
  - [ ] 安装 snap7 库
  - [ ] 实现 S7 客户端封装类
  - [ ] 实现 PLC 连接管理
  - [ ] 实现数据块 (DB) 写入
  - [ ] 支持 S7-200/300/400/1200/1500

- [ ] **配置和测试**
  - [ ] 添加 S7 配置项（PLC IP、Rack、Slot、DB Number）
  - [ ] 编写测试脚本（模拟 PLC 或使用真实 PLC）
  - [ ] 验证数据写入正确性
  - [ ] 性能测试（写入延迟、吞吐量）

### 🟡 P2 - OPC UA 客户端支持

- [ ] **OPC UA 通信模块开发**
  - [ ] 安装 open62541 库
  - [ ] 实现 OPC UA 客户端封装类
  - [ ] 实现服务器连接和认证
  - [ ] 实现变量节点写入
  - [ ] 支持不同安全策略（None/Sign/SignAndEncrypt）

- [ ] **配置和测试**
  - [ ] 添加 OPC UA 配置项（Server URL、安全模式、证书）
  - [ ] 编写测试脚本（使用 OPC UA 测试服务器）
  - [ ] 验证数据写入正确性
  - [ ] 性能测试

### 🟢 P3 - 协议扩展（可选）

- [ ] **MQTT 客户端**
  - [ ] 支持数据上报到 MQTT Broker
  - [ ] 支持 QoS、TLS/SSL
  - [ ] 适配阿里云、AWS IoT Core

- [ ] **Ethernet/IP**
  - [ ] 支持 Allen-Bradley PLC

- [ ] **PROFINET**
  - [ ] 支持西门子 PROFINET 设备

---

## 🎨 阶段四: 用户体验优化 (2-3 周)

### 🟡 P2 - GPIO 控制

- [ ] **按钮控制**
  - [ ] 安装 libgpiod 库
  - [ ] 实现按钮事件检测（短按、长按、超长按）
  - [ ] 短按: 切换协议模式
  - [ ] 长按 3s: 保存配置
  - [ ] 超长按 10s: 恢复出厂设置

- [ ] **LED 指示**
  - [ ] 红色 LED: 故障指示（慢闪/快闪/常亮）
  - [ ] 绿色 LED: 运行指示（呼吸灯/常亮）
  - [ ] 蓝色 LED: 通信指示（闪烁/常亮）

### 🟢 P3 - Web 界面美化

- [ ] **前端框架升级**
  - [ ] 使用 Vue.js 或 React 重写前端
  - [ ] 响应式设计（适配手机、平板）
  - [ ] 添加实时数据图表（ECharts）
  - [ ] 添加历史数据曲线
  - [ ] 添加告警通知

- [ ] **多语言支持**
  - [ ] 中文
  - [ ] 英文
  - [ ] 日文（可选）

---

## 📊 阶段五: 高级功能 (长期规划)

### 🟢 P3 - 数据记录和分析

- [ ] **本地数据库**
  - [ ] 使用 SQLite 存储历史数据
  - [ ] 数据保留策略（7天/30天/永久）
  - [ ] 数据压缩和归档
  - [ ] 数据导出（CSV/Excel）

- [ ] **数据分析**
  - [ ] 统计分析（最大值、最小值、平均值、标准差）
  - [ ] 趋势分析（移动平均、线性回归）
  - [ ] 异常检测（基于规则或机器学习）
  - [ ] 报表生成（日报、周报、月报）

### 🟢 P3 - 云平台对接

- [ ] **MQTT 云端上报**
  - [ ] 阿里云 IoT 平台
  - [ ] AWS IoT Core
  - [ ] 腾讯云 IoT Hub
  - [ ] 自建 MQTT Broker

- [ ] **远程监控**
  - [ ] 云端 Dashboard
  - [ ] 手机 APP
  - [ ] 微信小程序
  - [ ] 钉钉告警

### 🟢 P3 - 多通道扩展

- [ ] **硬件扩展**
  - [ ] 支持 4 路 RS-485 同时采集
  - [ ] 使用 USB Hub 或 PCIe 串口卡
  - [ ] 多线程并行采集

- [ ] **软件架构调整**
  - [ ] 多个 rs485d 实例
  - [ ] 统一的数据汇聚模块
  - [ ] 负载均衡

### 🟢 P3 - 边缘计算

- [ ] **本地推理**
  - [ ] 集成 TensorFlow Lite
  - [ ] 质量预测模型
  - [ ] 异常检测模型
  - [ ] 预测性维护

- [ ] **视觉检测**
  - [ ] 接入 USB 摄像头或工业相机
  - [ ] 表面缺陷检测
  - [ ] OCR 识别
  - [ ] 尺寸测量

---

## 🐛 已知问题 (Bugs)

### 当前版本 (v1.0)

- [ ] **Bug #1**: rs485d 使用模拟数据
  - **优先级**: P0
  - **描述**: 当前生成随机厚度值 (1.0-2.0 mm)，未连接实际设备
  - **解决方案**: 对接实际测厚仪，修改通信协议
  - **负责人**: TBD
  - **预计时间**: 1 周

- [ ] **Bug #2**: Web 界面无法修改配置
  - **优先级**: P1
  - **描述**: POST /api/config 接口未实现
  - **解决方案**: 实现配置更新和 60 秒回滚机制
  - **负责人**: TBD
  - **预计时间**: 3 天

- [ ] **Bug #3**: 无看门狗保护
  - **优先级**: P1
  - **描述**: 进程崩溃后无法自动重启
  - **解决方案**: 实现看门狗守护进程或使用 systemd 的 Restart=always
  - **负责人**: TBD
  - **预计时间**: 2 天

- [ ] **Bug #4**: 日志文件无轮转
  - **优先级**: P2
  - **描述**: 日志文件会无限增长
  - **解决方案**: 配置 logrotate 或实现内置轮转
  - **负责人**: TBD
  - **预计时间**: 1 天

---

## 📋 技术债务 (Technical Debt)

- [ ] **代码规范**
  - [ ] 统一代码风格（clang-format）
  - [ ] 添加代码静态分析（cppcheck）
  - [ ] 消除编译器警告
  - [ ] 遵循 C++ Core Guidelines

- [ ] **测试覆盖率**
  - [ ] 单元测试覆盖率 > 80%
  - [ ] 集成测试覆盖率 > 60%
  - [ ] 使用 gcov/lcov 生成覆盖率报告

- [ ] **依赖管理**
  - [ ] 使用 Conan 或 vcpkg 管理 C++ 依赖
  - [ ] 锁定依赖库版本
  - [ ] 定期更新依赖（安全补丁）

- [ ] **CI/CD**
  - [ ] 搭建 GitLab CI / GitHub Actions
  - [ ] 自动编译和测试
  - [ ] 自动生成固件镜像
  - [ ] 自动发布 Release

---

## 🎯 里程碑 (Milestones)

### M1: Ubuntu 测试版完成 (预计 3 周)
- ✅ 核心功能完整
- ✅ 代码添加详细中文注释
- ✅ 文档完善
- 🔲 对接实际测厚仪设备
- 🔲 数据准确性验证
- 🔲 Web 界面完善
- 🔲 性能基准测试

### M2: FriendlyWRT 生产版发布 (预计 7 周)
- 🔲 交叉编译环境搭建
- 🔲 FriendlyWRT 适配完成
- 🔲 固件打包和烧录测试
- 🔲 长稳测试（7×24 小时）
- 🔲 生产部署手册

### M3: 协议扩展版发布 (预计 13 周)
- 🔲 S7 客户端支持
- 🔲 OPC UA 客户端支持
- 🔲 GPIO 按钮和 LED 控制
- 🔲 看门狗和掉电保护

### M4: 企业级功能版 (预计 6 个月)
- 🔲 数据记录和分析
- 🔲 云平台对接
- 🔲 多通道扩展
- 🔲 边缘计算能力

---

## 📝 备注

### 优先级判断标准

- **P0 (紧急)**: 生产部署必须，影响核心功能
- **P1 (高)**: 重要功能，用户强需求
- **P2 (中)**: 增强功能，提升用户体验
- **P3 (低)**: 锦上添花，长期规划

### 时间估算说明

- 所有时间估算基于单人开发
- 包含开发、测试、文档时间
- 不包含等待硬件、外部依赖的时间

### 协作建议

- 优先完成 P0 和 P1 任务
- 每完成一个任务，更新此文档
- 遇到阻塞问题，及时记录到"已知问题"
- 定期 Review TODO，调整优先级

---

## ✅ 已完成 (Completed)

### 2025-10-10
- ✅ 创建项目基础结构
- ✅ 实现 RS-485 采集模块（模拟数据）
- ✅ 实现 Modbus TCP 服务器
- ✅ 实现 Web 配置界面（基础版）
- ✅ 实现无锁环形缓冲区
- ✅ 实现配置管理系统
- ✅ 实现日志系统
- ✅ 编写编译和启动脚本
- ✅ 编写 systemd 服务配置
- ✅ 编写 Python Modbus 测试客户端
- ✅ 为所有核心代码添加详细中文注释
- ✅ 编写完整的项目文档

---

**最后更新**: 2025-10-10  
**负责人**: Gateway Project Team  
**联系方式**: 参见 README.md
