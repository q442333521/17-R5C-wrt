# ğŸ“‹ S7 å’Œ OPC UA éƒ¨ç½²æ£€æŸ¥æ¸…å•

## âœ… å®‰è£…å‰æ£€æŸ¥

### ç¡¬ä»¶è¦æ±‚
- [ ] Ubuntu 22.04 ARM64 ç³»ç»Ÿ
- [ ] è‡³å°‘ 2GB RAM
- [ ] è‡³å°‘ 4GB å­˜å‚¨ç©ºé—´
- [ ] ç½‘ç»œè¿æ¥ (ç”¨äºä¸‹è½½ä¾èµ–)

### ç½‘ç»œè¦æ±‚
- [ ] èƒ½å¤Ÿè®¿é—® PLC/OPC UA æœåŠ¡å™¨
- [ ] é˜²ç«å¢™å…è®¸ä»¥ä¸‹ç«¯å£:
  - [ ] S7: ç«¯å£ 102 (TCP)
  - [ ] OPC UA: ç«¯å£ 4840 (TCP)
  - [ ] Modbus: ç«¯å£ 502/1502 (TCP)
  - [ ] Web: ç«¯å£ 8080 (TCP)

## ğŸ“¦ ä¾èµ–å®‰è£…

### 1. åŸºç¡€å·¥å…·
```bash
sudo apt update
sudo apt install -y build-essential cmake git pkg-config wget
```
- [ ] build-essential å·²å®‰è£…
- [ ] cmake å·²å®‰è£…
- [ ] git å·²å®‰è£…
- [ ] pkg-config å·²å®‰è£…

### 2. åè®®åº“
```bash
sudo apt install -y libmodbus-dev libjsoncpp-dev
```
- [ ] libmodbus-dev å·²å®‰è£…
- [ ] libjsoncpp-dev å·²å®‰è£…

### 3. S7 å’Œ OPC UA åº“
```bash
sudo ./scripts/install_deps.sh
```
- [ ] Snap7 1.4.2 å·²å®‰è£… (`/usr/local/lib/libsnap7.so`)
- [ ] open62541 1.3.5 å·²å®‰è£… (`/usr/local/lib/libopen62541.so`)
- [ ] åŠ¨æ€é“¾æ¥åº“ç¼“å­˜å·²æ›´æ–° (`ldconfig`)

### 4. Python æµ‹è¯•å·¥å…· (å¯é€‰)
```bash
pip3 install pymodbus python-snap7 opcua
```
- [ ] pymodbus å·²å®‰è£…
- [ ] python-snap7 å·²å®‰è£… (ç”¨äºæ¨¡æ‹ŸæœåŠ¡å™¨)
- [ ] opcua å·²å®‰è£… (ç”¨äºæ¨¡æ‹ŸæœåŠ¡å™¨)

## ğŸ”¨ ç¼–è¯‘æ£€æŸ¥

### 1. æ¸…ç†æ—§ç¼–è¯‘
```bash
rm -rf build
```
- [ ] æ—§çš„ build ç›®å½•å·²åˆ é™¤

### 2. ç¼–è¯‘é¡¹ç›®
```bash
./scripts/build.sh
```
- [ ] CMake é…ç½®æˆåŠŸ
- [ ] æ‰¾åˆ° Snap7 åº“
- [ ] æ‰¾åˆ° open62541 åº“
- [ ] ç¼–è¯‘æ— é”™è¯¯
- [ ] ç¼–è¯‘æ— è­¦å‘Š

### 3. éªŒè¯å¯æ‰§è¡Œæ–‡ä»¶
```bash
ls -lh build/src/*/
```
- [ ] `rs485d` å­˜åœ¨
- [ ] `modbusd` å­˜åœ¨
- [ ] `s7d` å­˜åœ¨ âœ¨
- [ ] `opcuad` å­˜åœ¨ âœ¨
- [ ] `webcfg` å­˜åœ¨

## âš™ï¸ é…ç½®æ£€æŸ¥

### 1. é…ç½®æ–‡ä»¶
```bash
cat config/config.json
```
- [ ] é…ç½®æ–‡ä»¶å­˜åœ¨
- [ ] JSON æ ¼å¼æ­£ç¡®

### 2. S7 é…ç½®
```json
{
  "protocol": {
    "s7": {
      "enabled": true,
      "plc_ip": "192.168.1.10",
      "rack": 0,
      "slot": 1,
      "db_number": 10,
      "update_interval_ms": 50
    }
  }
}
```
- [ ] S7 é…ç½®å­˜åœ¨
- [ ] PLC IP åœ°å€æ­£ç¡®
- [ ] Rack/Slot é…ç½®æ­£ç¡®
- [ ] DB å—ç¼–å·æ­£ç¡®

### 3. OPC UA é…ç½®
```json
{
  "protocol": {
    "opcua": {
      "enabled": true,
      "server_url": "opc.tcp://192.168.1.20:4840",
      "security_mode": "None",
      "username": "",
      "password": ""
    }
  }
}
```
- [ ] OPC UA é…ç½®å­˜åœ¨
- [ ] æœåŠ¡å™¨åœ°å€æ­£ç¡®
- [ ] å®‰å…¨æ¨¡å¼é…ç½®æ­£ç¡®
- [ ] è®¤è¯ä¿¡æ¯æ­£ç¡® (å¦‚æœéœ€è¦)

### 4. æ¿€æ´»åè®®
```json
{
  "protocol": {
    "active": "modbus"  // æˆ– "s7" æˆ– "opcua"
  }
}
```
- [ ] `active` å­—æ®µå·²è®¾ç½®
- [ ] å€¼ä¸º "modbus", "s7", æˆ– "opcua" ä¹‹ä¸€

## ğŸŒ ç½‘ç»œè¿é€šæ€§æ£€æŸ¥

### 1. S7 PLC
```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping -c 3 192.168.1.10

# æ£€æŸ¥ç«¯å£ (éœ€è¦ telnet)
telnet 192.168.1.10 102
```
- [ ] PLC å¯ä»¥ ping é€š
- [ ] ç«¯å£ 102 å¯ä»¥è¿æ¥

### 2. OPC UA æœåŠ¡å™¨
```bash
# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping -c 3 192.168.1.20

# æ£€æŸ¥ç«¯å£
telnet 192.168.1.20 4840
```
- [ ] æœåŠ¡å™¨å¯ä»¥ ping é€š
- [ ] ç«¯å£ 4840 å¯ä»¥è¿æ¥

## ğŸš€ å¯åŠ¨æ£€æŸ¥

### 1. å¯åŠ¨æœåŠ¡
```bash
./scripts/start.sh
```
- [ ] rs485d å¯åŠ¨æˆåŠŸ
- [ ] modbusd å¯åŠ¨æˆåŠŸ
- [ ] s7d å¯åŠ¨æˆåŠŸ âœ¨
- [ ] opcuad å¯åŠ¨æˆåŠŸ âœ¨
- [ ] webcfg å¯åŠ¨æˆåŠŸ

### 2. æ£€æŸ¥è¿›ç¨‹
```bash
ps aux | grep -E "rs485d|modbusd|s7d|opcuad|webcfg"
```
- [ ] æ‰€æœ‰è¿›ç¨‹è¿è¡Œä¸­
- [ ] PID æ–‡ä»¶å·²åˆ›å»º (`/tmp/gw-test/*.pid`)

### 3. æ£€æŸ¥æ—¥å¿—
```bash
ls -lh /tmp/gw-test/logs/
```
- [ ] rs485d.log å­˜åœ¨
- [ ] modbusd.log å­˜åœ¨
- [ ] s7d.log å­˜åœ¨ âœ¨
- [ ] opcuad.log å­˜åœ¨ âœ¨
- [ ] webcfg.log å­˜åœ¨

### 4. æŸ¥çœ‹æ—¥å¿—å†…å®¹
```bash
tail -n 20 /tmp/gw-test/logs/s7d.log
tail -n 20 /tmp/gw-test/logs/opcuad.log
```
- [ ] s7d æ—¥å¿—æ— é”™è¯¯
- [ ] opcuad æ—¥å¿—æ— é”™è¯¯
- [ ] æ˜¾ç¤ºè¿æ¥æˆåŠŸæˆ–æ­£åœ¨é‡è¯•

## ğŸ” åŠŸèƒ½æµ‹è¯•

### 1. Modbus TCP æµ‹è¯•
```bash
python3 tests/test_modbus_client.py
```
- [ ] å¯ä»¥è¿æ¥åˆ° Modbus æœåŠ¡å™¨
- [ ] å¯ä»¥è¯»å–å¯„å­˜å™¨
- [ ] æ•°æ®å®æ—¶æ›´æ–°

### 2. S7 è¿æ¥æµ‹è¯•
```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f /tmp/gw-test/logs/s7d.log
```
é¢„æœŸè¾“å‡º:
```
[INFO] S7 è¿æ¥æˆåŠŸ: 192.168.1.10 (Rack=0, Slot=1)
[DEBUG] S7 å†™å…¥æˆåŠŸ: thickness=1.234 mm, seq=100
```
- [ ] æ˜¾ç¤º "S7 è¿æ¥æˆåŠŸ"
- [ ] æ˜¾ç¤º "S7 å†™å…¥æˆåŠŸ"
- [ ] æ— é”™è¯¯ä¿¡æ¯

### 3. OPC UA è¿æ¥æµ‹è¯•
```bash
# æŸ¥çœ‹æ—¥å¿—
tail -f /tmp/gw-test/logs/opcuad.log
```
é¢„æœŸè¾“å‡º:
```
[INFO] OPC UA è¿æ¥æˆåŠŸ: opc.tcp://192.168.1.20:4840
[DEBUG] OPC UA å†™å…¥æˆåŠŸ: thickness=1.234 mm, seq=100
```
- [ ] æ˜¾ç¤º "OPC UA è¿æ¥æˆåŠŸ"
- [ ] æ˜¾ç¤º "OPC UA å†™å…¥æˆåŠŸ"
- [ ] æ— é”™è¯¯ä¿¡æ¯

### 4. åè®®åˆ‡æ¢æµ‹è¯•
```bash
# ä¿®æ”¹é…ç½®åˆ‡æ¢åè®®
vim config/config.json
# ä¿®æ”¹ "active" å­—æ®µ

# è§‚å¯Ÿæ—¥å¿—,åº”è¯¥åœ¨ 1 ç§’å†…ç”Ÿæ•ˆ
tail -f /tmp/gw-test/logs/s7d.log
```
- [ ] é…ç½®ä¿®æ”¹åè‡ªåŠ¨é‡è½½
- [ ] æ—§åè®®åœæ­¢å†™å…¥
- [ ] æ–°åè®®å¼€å§‹å†™å…¥

### 5. Web ç•Œé¢æµ‹è¯•
```bash
# åœ¨æµè§ˆå™¨è®¿é—®
http://<è®¾å¤‡IP>:8080
```
- [ ] Web ç•Œé¢å¯ä»¥è®¿é—®
- [ ] æ˜¾ç¤ºå®æ—¶æ•°æ®
- [ ] æ˜¾ç¤ºå½“å‰æ¿€æ´»çš„åè®®
- [ ] æ˜¾ç¤º S7/OPC UA è¿æ¥çŠ¶æ€

## ğŸ“Š æ€§èƒ½æ£€æŸ¥

### 1. CPU ä½¿ç”¨ç‡
```bash
top -p $(pgrep -d',' -f "rs485d|modbusd|s7d|opcuad|webcfg")
```
- [ ] æ‰€æœ‰è¿›ç¨‹ CPU < 10%
- [ ] æ— å¼‚å¸¸é«˜ CPU å ç”¨

### 2. å†…å­˜ä½¿ç”¨
```bash
ps aux | grep -E "rs485d|modbusd|s7d|opcuad|webcfg" | awk '{print $6/1024 " MB - " $11}'
```
- [ ] æ¯ä¸ªè¿›ç¨‹ < 50 MB
- [ ] æ— å†…å­˜æ³„æ¼

### 3. å†™å…¥ç»Ÿè®¡
```bash
# è§‚å¯Ÿ 10 ç§’ç»Ÿè®¡è¾“å‡º
tail -f /tmp/gw-test/logs/s7d.log | grep "ç»Ÿè®¡"
```
é¢„æœŸè¾“å‡º:
```
[INFO] S7 ç»Ÿè®¡: æ€»å†™å…¥=500, å¤±è´¥=0, å¤±è´¥ç‡=0.00%
```
- [ ] å¤±è´¥ç‡ < 1%
- [ ] å†™å…¥é¢‘ç‡ç¬¦åˆé…ç½®

## ğŸ›¡ï¸ PLC/æœåŠ¡å™¨ç«¯éªŒè¯

### S7 PLC ç«¯æ£€æŸ¥
åœ¨ TIA Portal ä¸­:
- [ ] DB å—å·²åˆ›å»º
- [ ] DB å—å¤§å° >= 16 å­—èŠ‚
- [ ] åœ¨çº¿ç›‘æ§å¯ä»¥çœ‹åˆ°æ•°æ®å˜åŒ–
- [ ] åšåº¦å€¼å®æ—¶æ›´æ–°
- [ ] æ—¶é—´æˆ³å®æ—¶æ›´æ–°

### OPC UA æœåŠ¡å™¨ç«¯æ£€æŸ¥
ä½¿ç”¨ UAExpert æˆ–å…¶ä»–å®¢æˆ·ç«¯:
- [ ] å‘½åç©ºé—´å­˜åœ¨ (ns=2)
- [ ] å˜é‡èŠ‚ç‚¹å­˜åœ¨:
  - [ ] Gateway.Thickness
  - [ ] Gateway.Timestamp
  - [ ] Gateway.Status
  - [ ] Gateway.Sequence
- [ ] å˜é‡å€¼å®æ—¶æ›´æ–°

## ğŸ”„ ç¨³å®šæ€§æµ‹è¯•

### 1. æ–­ç½‘é‡è¿æµ‹è¯•
```bash
# æ–­å¼€ PLC/æœåŠ¡å™¨ç½‘ç»œ
# è§‚å¯Ÿæ—¥å¿—

tail -f /tmp/gw-test/logs/s7d.log
```
é¢„æœŸè¡Œä¸º:
- [ ] æ£€æµ‹åˆ°è¿æ¥æ–­å¼€
- [ ] æ¯ 5 ç§’å°è¯•é‡è¿
- [ ] ç½‘ç»œæ¢å¤åè‡ªåŠ¨é‡è¿
- [ ] æ¢å¤åç»§ç»­å†™å…¥æ•°æ®

### 2. é•¿æ—¶é—´è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œ 24 å°æ—¶
# å®šæœŸæ£€æŸ¥æ—¥å¿—å’ŒçŠ¶æ€
```
- [ ] æ— å´©æºƒ
- [ ] æ— å†…å­˜æ³„æ¼
- [ ] æ— å¼‚å¸¸é‡å¯
- [ ] å†™å…¥æˆåŠŸç‡ > 99%

### 3. é…ç½®çƒ­é‡è½½æµ‹è¯•
```bash
# å¤šæ¬¡ä¿®æ”¹é…ç½®å¹¶ä¿å­˜
vim config/config.json

# è§‚å¯Ÿæ˜¯å¦è‡ªåŠ¨ç”Ÿæ•ˆ
tail -f /tmp/gw-test/logs/*.log
```
- [ ] ä¿®æ”¹å 1 ç§’å†…ç”Ÿæ•ˆ
- [ ] æ— éœ€é‡å¯æœåŠ¡
- [ ] æ— é”™è¯¯ä¿¡æ¯

## ğŸ” å®‰å…¨æ£€æŸ¥

### 1. æ–‡ä»¶æƒé™
```bash
ls -l /opt/gw/conf/
ls -l /opt/gw/bin/
```
- [ ] é…ç½®æ–‡ä»¶æƒé™æ­£ç¡® (644 æˆ–æ›´ä¸¥æ ¼)
- [ ] å¯æ‰§è¡Œæ–‡ä»¶æƒé™æ­£ç¡® (755)

### 2. ç½‘ç»œå®‰å…¨
- [ ] ä½¿ç”¨ç‹¬ç«‹ VLAN (ç”Ÿäº§ç¯å¢ƒ)
- [ ] é…ç½®é˜²ç«å¢™è§„åˆ™
- [ ] é™åˆ¶è®¿é—® IP (å¦‚æœå¯èƒ½)

### 3. OPC UA å®‰å…¨
å¦‚æœä½¿ç”¨è®¤è¯:
- [ ] ç”¨æˆ·åå¯†ç ä¸ä¸ºç©º
- [ ] å¯†ç å¼ºåº¦è¶³å¤Ÿ
- [ ] è€ƒè™‘ä½¿ç”¨åŠ å¯†æ¨¡å¼ (SignAndEncrypt)

## ğŸ“ æ–‡æ¡£æ£€æŸ¥

- [ ] å·²é˜…è¯» [S7_OPCUA_GUIDE.md](docs/S7_OPCUA_GUIDE.md)
- [ ] å·²é˜…è¯» [S7_OPCUA_IMPLEMENTATION.md](S7_OPCUA_IMPLEMENTATION.md)
- [ ] å·²äº†è§£é…ç½®æ–‡ä»¶æ ¼å¼
- [ ] å·²äº†è§£æ•…éšœæ’æŸ¥æ–¹æ³•

## âœ… ç”Ÿäº§éƒ¨ç½²æ¸…å•

### Systemd æœåŠ¡å®‰è£…
```bash
sudo cp systemd/*.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable gw-rs485d gw-modbusd gw-s7d gw-opcuad gw-webcfg
sudo systemctl start gw-rs485d gw-modbusd gw-s7d gw-opcuad gw-webcfg
```
- [ ] æœåŠ¡æ–‡ä»¶å·²å¤åˆ¶
- [ ] æœåŠ¡å·²å¯ç”¨
- [ ] æœåŠ¡å·²å¯åŠ¨
- [ ] å¼€æœºè‡ªå¯åŠ¨å·²é…ç½®

### æ—¥å¿—è½®è½¬
```bash
sudo vim /etc/logrotate.d/gateway
```
- [ ] æ—¥å¿—è½®è½¬å·²é…ç½®
- [ ] æ—¥å¿—ä¿ç•™ç­–ç•¥æ­£ç¡®

### ç›‘æ§
- [ ] é…ç½®è¿›ç¨‹ç›‘æ§ (å¦‚ Monit)
- [ ] é…ç½®å‘Šè­¦ (å¦‚ email/SMS)
- [ ] é…ç½®æ€§èƒ½ç›‘æ§ (å¦‚ Prometheus)

## ğŸ“ æ”¯æŒä¿¡æ¯

### æ—¥å¿—ä½ç½®
- å¼€å‘ç¯å¢ƒ: `/tmp/gw-test/logs/`
- ç”Ÿäº§ç¯å¢ƒ: `/var/log/gateway/`

### é…ç½®æ–‡ä»¶
- å¼€å‘ç¯å¢ƒ: `config/config.json`
- ç”Ÿäº§ç¯å¢ƒ: `/opt/gw/conf/config.json`

### å¸¸ç”¨å‘½ä»¤
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status gw-*

# æŸ¥çœ‹æ—¥å¿—
journalctl -u gw-s7d -f
journalctl -u gw-opcuad -f

# é‡å¯æœåŠ¡
systemctl restart gw-s7d
systemctl restart gw-opcuad

# æŸ¥çœ‹é…ç½®
cat /opt/gw/conf/config.json

# æµ‹è¯•è¿æ¥
telnet <PLC_IP> 102
telnet <OPCUA_IP> 4840
```

---

**æ£€æŸ¥å®Œæˆæ—¥æœŸ**: __________  
**æ£€æŸ¥äºº**: __________  
**ç‰ˆæœ¬**: v2.0  
**çŠ¶æ€**: â¬œ é€šè¿‡ / â¬œ å¤±è´¥
