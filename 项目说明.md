# å·¥ä¸šæœºåºŠæ•°æ®é‡‡é›†ç½‘å…³å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ

**åŸºäº NanoPi R5S (2GB+32GB eMMC) çš„ Linux å®ç°**

---

## ğŸ“‹ æ–‡æ¡£ç‰ˆæœ¬

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| v2.0 | 2025-10-10 | å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆï¼Œä¿®æ­£ç¡¬ä»¶æ¥å£ã€æ€§èƒ½æŒ‡æ ‡ã€æ¶æ„ç»†èŠ‚ | - |

---

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

å·¥ä¸šæœºåºŠé…ç½®çš„æµ‹åšä»ªé€šè¿‡ **RS-485** æ€»çº¿è¾“å‡ºå®æ—¶åšåº¦æ•°æ®ï¼Œéœ€è¦é€šè¿‡ä»¥å¤ªç½‘å°†æ•°æ®ä¼ è¾“è‡³ä¸åŒå“ç‰Œçš„ CNC/PLC ç³»ç»Ÿï¼ˆè¥¿é—¨å­ã€å¹¿æ•°ã€åä¸­ã€æµ·å¾·æ±‰ç­‰ï¼‰ã€‚ä¸ºæ»¡è¶³å¤šåè®®é€‚é…éœ€æ±‚ï¼Œæœ¬ç½‘å…³éœ€æ”¯æŒï¼š

- **Modbus TCP**ï¼ˆé€šç”¨å·¥ä¸šåè®®ï¼‰
- **Siemens S7**ï¼ˆè¥¿é—¨å­ PLCï¼‰
- **OPC UA**ï¼ˆç°ä»£å·¥ä¸šäº’è”æ ‡å‡†ï¼‰

æœ¬é¡¹ç›®é‡‡ç”¨ **NanoPi R5S (RK3568)** ä½œä¸ºç¡¬ä»¶å¹³å°ï¼Œè¿è¡Œ **Ubuntu 22.04 arm64** ç³»ç»Ÿï¼Œä½¿ç”¨ **çº¯ C++ æŠ€æœ¯æ ˆ**ï¼Œå®ç°é«˜æ€§èƒ½ã€é«˜å¯é çš„å·¥ä¸šç½‘å…³ã€‚

### 1.2 æ ¸å¿ƒè®¾è®¡ç›®æ ‡

| ç›®æ ‡ç±»åˆ« | æŒ‡æ ‡è¦æ±‚ |
|---------|----------|
| **å®æ—¶æ€§** | RS-485 é‡‡æ ·å‘¨æœŸ 20ms (50Hz)ï¼Œåè®®å“åº” â‰¤ 50ms |
| **ç¨³å®šæ€§** | 7Ã—24 å°æ—¶è¿ç»­è¿è¡Œï¼ŒMTBF > 10,000 å°æ—¶ |
| **å¯é æ€§** | æ‰ç”µæ•°æ®ä¸ä¸¢å¤±ï¼Œé…ç½®è‡ªåŠ¨å¤‡ä»½ï¼Œçœ‹é—¨ç‹—ä¿æŠ¤ |
| **æ˜“ç»´æŠ¤** | Web é…ç½®ç•Œé¢ï¼Œè¿œç¨‹å›ºä»¶å‡çº§ï¼Œæ—¥å¿—è‡ªåŠ¨è½®è½¬ |
| **å¯æ‰©å±•** | æ¨¡å—åŒ–æ¶æ„ï¼Œæ”¯æŒæœªæ¥æ‰©å±• MQTTã€CAN ç­‰åè®® |

---

## äºŒã€ç¡¬ä»¶å¹³å°ä¸æ¥å£

### 2.1 ç¡¬ä»¶è§„æ ¼

| ç»„ä»¶ | è§„æ ¼ | è¯´æ˜ |
|------|------|------|
| **SoC** | Rockchip RK3568 (4Ã—Cortex-A55 @2.0GHz) | 22nm å·¥è‰ºï¼Œæ”¯æŒç¡¬ä»¶åŠ å¯† |
| **å†…å­˜** | 2GB LPDDR4X | å®é™…å¯ç”¨çº¦ 1.8GB |
| **å­˜å‚¨** | 32GB eMMC 5.1 | é¡ºåºè¯» 280MB/sï¼Œå†™ 200MB/s |
| **ç½‘ç»œ** | 2Ã—RTL8125BG 2.5GbE | ä¸€ä¸ªç”¨äºä¸Šä½æœºï¼Œä¸€ä¸ªå¤‡ç”¨ |
| **ä¸²å£** | UART0 (Debug) | é€šè¿‡ USB è½¬æ¥å™¨æ‰©å±• RS-485 |
| **USB** | 1Ã—USB3.0 + 1Ã—USB2.0 | USB-RS485 è½¬æ¢å™¨æ¥å£ |
| **GPIO** | 40-Pin Header | æŒ‰é’®è¾“å…¥ + LED æŒ‡ç¤º |
| **ä¾›ç”µ** | DC 5V/3A (Type-C) | å·¥ä¸šç‰ˆéœ€ 9-36V DC/DC æ¨¡å— |
| **å·¥ä½œæ¸©åº¦** | 0-70Â°C (å¼€å‘æ¿) | å·¥ä¸šç‰ˆæ•£çƒ­ç‰‡å¯æ‰©å±•è‡³ -20~80Â°C |

### 2.2 æ¥å£ä½¿ç”¨è§„åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         NanoPi R5S æ¥å£å¸ƒå±€          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LAN1 (eth0)  â†’ ä¸Šä½æœºç½‘ç»œ (CNC/PLC)  â”‚
â”‚ LAN2 (eth1)  â†’ ç®¡ç†ç½‘ç»œ (Webé…ç½®)    â”‚
â”‚ USB3.0       â†’ USB-RS485 è½¬æ¢å™¨      â”‚
â”‚ GPIO17       â†’ æŒ‰é’® K1 (åè®®åˆ‡æ¢)    â”‚
â”‚ GPIO18       â†’ LED1 çº¢è‰² (æ•…éšœ)      â”‚
â”‚ GPIO19       â†’ LED2 ç»¿è‰² (è¿è¡Œ)      â”‚
â”‚ GPIO20       â†’ LED3 è“è‰² (é€šä¿¡)      â”‚
â”‚ UART0        â†’ è°ƒè¯•ä¸²å£ (115200)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 RS-485 è¿æ¥æ–¹æ¡ˆ

**ä½¿ç”¨ USB è½¬ RS-485 æ¨¡å—** (æ¨èå‹å·)ï¼š
- CH340G/CH341A èŠ¯ç‰‡ (Linux åŸç”Ÿæ”¯æŒ)
- FTDI FT232RL (å·¥ä¸šçº§)
- è‡ªåŠ¨æ–¹å‘æ§åˆ¶æˆ–è½¯ä»¶æ§åˆ¶ RTS/DTR

```bash
# è®¾å¤‡èŠ‚ç‚¹
/dev/ttyUSB0  â†’  RS-485 æµ‹åšä»ª
/dev/ttyS0    â†’  è°ƒè¯•ä¸²å£ (UART0)
```

---

## ä¸‰ã€è½¯ä»¶ç³»ç»Ÿæ¶æ„

### 3.1 ç³»ç»Ÿåˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Web é…ç½®æ¥å£ (Port 8080)            â”‚
â”‚         (civetweb + JSON REST API)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          åè®®å±‚ (Protocol Daemons)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ modbusd  â”‚   s7d    â”‚    opcuad        â”‚ â”‚
â”‚  â”‚ (Port502)â”‚ (S7 Cli) â”‚  (OPC UA Cli)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         æ•°æ®äº¤æ¢å±‚ (Shared Memory)            â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚  NDM Ring Buffer (Lock-Free)     â”‚     â”‚
â”‚    â”‚  åšåº¦ | æ—¶é—´æˆ³ | çŠ¶æ€ | åºåˆ—å·    â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           é‡‡é›†å±‚ (rs485d Daemon)             â”‚
â”‚      50Hz è½®è¯¢ + å¼‚å¸¸æ£€æµ‹ + æ•°æ®æ ¡éªŒ          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ç¡¬ä»¶æŠ½è±¡å±‚ (HAL & Drivers)           â”‚
â”‚    USB-Serial | GPIO | Watchdog | RTC        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æ ¸å¿ƒæ¨¡å—è¯´æ˜

| æ¨¡å—å | åŠŸèƒ½ | å®ç°è¯­è¨€ | é€šä¿¡æ–¹å¼ |
|--------|------|----------|----------|
| **rs485d** | RS-485 æ•°æ®é‡‡é›†ï¼Œ50Hz è½®è¯¢ | C++ | â†’ Shared Memory |
| **modbusd** | Modbus TCP ä»ç«™æœåŠ¡å™¨ | C++ (libmodbus) | â† Shared Memory |
| **s7d** | Siemens S7 å®¢æˆ·ç«¯ | C++ (snap7) | â† Shared Memory |
| **opcuad** | OPC UA å®¢æˆ·ç«¯ | C++ (open62541) | â† Shared Memory |
| **webcfg** | Web é…ç½®ç®¡ç†æœåŠ¡ | C++ (civetweb) | RESTful API |
| **gpioctl** | æŒ‰é’®/LED æ§åˆ¶ | C++ (libgpiod) | äº‹ä»¶é©±åŠ¨ |
| **watchdog** | ç³»ç»Ÿçœ‹é—¨ç‹—å®ˆæŠ¤ | C++ | å®šæ—¶å–‚ç‹— |

### 3.3 æ•°æ®æ¨¡å‹ (NDM - Normalized Data Model)

```cpp
// ç»Ÿä¸€æ•°æ®äº¤æ¢ç»“æ„ä½“
struct NormalizedData {
    uint64_t timestamp_ns;      // çº³ç§’æ—¶é—´æˆ³ (CLOCK_MONOTONIC)
    uint32_t sequence;          // åºåˆ—å· (å¾ªç¯è®¡æ•°)
    float    thickness_mm;      // åšåº¦å€¼ (mm, IEEE754)
    uint16_t status;            // çŠ¶æ€ä½ (è§ä¸‹è¡¨)
    uint16_t reserved;          // ä¿ç•™å­—æ®µ
    uint8_t  crc8;              // æ•°æ®æ ¡éªŒ
} __attribute__((packed));      // 24 å­—èŠ‚ï¼Œç¼“å­˜è¡Œå¯¹é½
```

**çŠ¶æ€ä½å®šä¹‰**ï¼š
```
Bit 0:   æ•°æ®æœ‰æ•ˆ (1=Valid, 0=Invalid)
Bit 1:   RS-485 é€šä¿¡æ­£å¸¸ (1=OK, 0=Error)
Bit 2:   CRC æ ¡éªŒé€šè¿‡
Bit 3:   æµ‹åšä»ªä¼ æ„Ÿå™¨æ­£å¸¸
Bit 4-7: ä¿ç•™
Bit 8-15: é”™è¯¯ä»£ç  (0=æ— é”™è¯¯)
```

---

## å››ã€è¯¦ç»†åŠŸèƒ½è®¾è®¡

### 4.1 RS-485 é‡‡é›†æ¨¡å— (rs485d)

#### 4.1.1 è®¾è®¡æŒ‡æ ‡

| å‚æ•° | æ•°å€¼ | å¤‡æ³¨ |
|------|------|------|
| é‡‡æ ·é¢‘ç‡ | **50Hz (20ms å‘¨æœŸ)** | æ¯”åŸ 100Hz é™ä½ï¼Œæé«˜å¯é æ€§ |
| æ³¢ç‰¹ç‡ | 9600/19200 å¯é…ç½® | é»˜è®¤ 19200 |
| æ•°æ®ä½ | 8N1 | 8 æ•°æ®ä½ï¼Œæ— æ ¡éªŒï¼Œ1 åœæ­¢ä½ |
| è¶…æ—¶æ—¶é—´ | 200ms | å•æ¬¡æŸ¥è¯¢è¶…æ—¶ |
| é‡è¯•æ¬¡æ•° | 3 æ¬¡ | å¤±è´¥åé‡è¯• |
| é”™è¯¯ç‡é˜ˆå€¼ | < 0.1% | è¿ç»­ 10 æ¬¡é”™è¯¯åˆ™å‘Šè­¦ |

#### 4.1.2 çŠ¶æ€æœºè®¾è®¡

```
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   STARTâ”€â”€â”¤  INIT   â”œâ”€â”€æ‰“å¼€ä¸²å£â”€â”€â”
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â†“
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  IDLE   â”œâ”€â”€â”€â”€â”
          â†“                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
    â”‚  QUERY   â”œâ”€â”€å‘é€æŸ¥è¯¢å¸§â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
          â†“                                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          è¶…æ—¶/é”™è¯¯       â”‚
    â”‚  WAIT    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
          â†“                                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
    â”‚  PARSE   â”œâ”€â”€CRCæ ¡éªŒâ”€â”€æ•°æ®æœ‰æ•ˆâ”€â”€â”€â”€â”€â”€â”€â”¤
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
          â†“                                â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
    â”‚ PUBLISH  â”œâ”€â”€å†™å…¥å…±äº«å†…å­˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†“
    (20ms å®šæ—¶å™¨è§¦å‘ä¸‹ä¸€è½®)
```

#### 4.1.3 å¼‚å¸¸å¤„ç†

| å¼‚å¸¸ç±»å‹ | å¤„ç†ç­–ç•¥ | æ¢å¤æœºåˆ¶ |
|---------|---------|---------|
| ä¸²å£æ‰“å¼€å¤±è´¥ | 5 ç§’åé‡è¯•ï¼Œè®°å½•æ—¥å¿— | æœ€å¤šé‡è¯• 10 æ¬¡åè¿›å…¥æ•…éšœçŠ¶æ€ |
| é€šä¿¡è¶…æ—¶ | æ ‡è®°æ•°æ®æ— æ•ˆï¼Œè§¦å‘é‡è¯• | 3 æ¬¡é‡è¯•å¤±è´¥åæŠ¥è­¦ï¼ŒLED é—ªçƒ |
| CRC æ ¡éªŒå¤±è´¥ | ä¸¢å¼ƒæ•°æ®ï¼Œè®¡æ•°å™¨+1 | é”™è¯¯ç‡è¶… 5% æ—¶è®°å½•è¯¦ç»†æ—¥å¿— |
| è®¾å¤‡æ–­å¼€ | è‡ªåŠ¨é‡æ–°æšä¸¾ USB è®¾å¤‡ | udev äº‹ä»¶è§¦å‘é‡è¿ |

### 4.2 Modbus TCP ä»ç«™ (modbusd)

#### 4.2.1 å¯„å­˜å™¨æ˜ å°„è¡¨

| å¯„å­˜å™¨åœ°å€ | æ•°æ®ç±»å‹ | å­—èŠ‚åº | è¯´æ˜ |
|-----------|---------|--------|------|
| 40001-40002 | Float32 | Big-Endian | åšåº¦å€¼ (mm) |
| 40003-40004 | Uint64 | Big-Endian | æ—¶é—´æˆ³ (Unix ms) |
| 40005 | Uint16 | - | çŠ¶æ€ä½ |
| 40006 | Uint16 | - | åºåˆ—å· (ä½ 16 ä½) |
| 40007-40010 | Reserved | - | ä¿ç•™æ‰©å±• |

#### 4.2.2 æ€§èƒ½æŒ‡æ ‡

```
å¹¶å‘è¿æ¥æ•°:     æœ€å¤§ 32 ä¸ªå®¢æˆ·ç«¯
ååé‡:         3,000 TPS (å•çº¿ç¨‹)
å“åº”å»¶è¿Ÿ:       P50 < 2ms, P99 < 10ms
å†…å­˜å ç”¨:       < 10MB
```

#### 4.2.3 å®ç°è¦ç‚¹

```cpp
// ä½¿ç”¨ libmodbus åº“
modbus_t *ctx = modbus_new_tcp("0.0.0.0", 502);
modbus_mapping_t *mb_mapping = modbus_mapping_new(0, 0, 100, 0);

// æ³¨å†Œæ›´æ–°å›è°ƒ (ä»å…±äº«å†…å­˜è¯»å–)
void update_registers() {
    NormalizedData* data = shm_read_latest();
    uint16_t* regs = mb_mapping->tab_registers;
    
    // Float32 è½¬ 2Ã—Uint16 (Big-Endian)
    memcpy(&regs[0], &data->thickness_mm, 4);
    swap_bytes_if_needed(regs, 2);
    
    // Uint64 æ—¶é—´æˆ³
    memcpy(&regs[2], &data->timestamp_ns, 8);
    
    // çŠ¶æ€ä½
    regs[4] = data->status;
    regs[5] = data->sequence & 0xFFFF;
}
```

### 4.3 Siemens S7 å®¢æˆ·ç«¯ (s7d)

#### 4.3.1 æ”¯æŒçš„ PLC å‹å·

| PLC ç³»åˆ— | åè®®ç±»å‹ | æµ‹è¯•çŠ¶æ€ |
|---------|---------|---------|
| S7-200 Smart | S7Comm | âœ… å·²éªŒè¯ |
| S7-1200 | S7Comm-Plus | âœ… å·²éªŒè¯ |
| S7-1500 | S7Comm-Plus | ğŸŸ¡ éœ€å›ºä»¶ >= V2.0 |
| S7-300/400 | S7Comm | âœ… å·²éªŒè¯ |

#### 4.3.2 æ•°æ®å— (DB) æ˜ å°„

```
DB Block:     DB10 (å¯é…ç½®)
Offset:       DBD0   â†’ åšåº¦å€¼ (Real, 4å­—èŠ‚)
              DBD4   â†’ æ—¶é—´æˆ³ (DInt, 4å­—èŠ‚)
              DBW8   â†’ çŠ¶æ€ä½ (Word, 2å­—èŠ‚)
              DBW10  â†’ åºåˆ—å· (Word, 2å­—èŠ‚)
```

#### 4.3.3 è¿æ¥ç®¡ç†

```cpp
// ä½¿ç”¨ snap7 åº“
TS7Client *client = new TS7Client();
client->ConnectTo("192.168.1.100", 0, 1); // IP, Rack, Slot

// å‘¨æœŸå†™å…¥ (50ms å®šæ—¶å™¨)
void s7_update_loop() {
    NormalizedData* data = shm_read_latest();
    byte buffer[12];
    
    // æ‹·è´æ•°æ®åˆ°ç¼“å†²åŒº (æ³¨æ„å­—èŠ‚åºè½¬æ¢)
    S7_SetRealAt(buffer, 0, data->thickness_mm);
    S7_SetDIntAt(buffer, 4, data->timestamp_ns / 1000000);
    S7_SetWordAt(buffer, 8, data->status);
    S7_SetWordAt(buffer, 10, data->sequence);
    
    // å†™å…¥ PLC
    int res = client->DBWrite(10, 0, 12, buffer);
    if (res != 0) handle_s7_error(res);
}
```

### 4.4 OPC UA å®¢æˆ·ç«¯ (opcuad)

#### 4.4.1 èŠ‚ç‚¹åœ°å€è®¾è®¡

```
Root Node: ns=2;s=ThicknessGateway

å˜é‡èŠ‚ç‚¹:
  â”œâ”€ Thickness       (Float, ns=2;s=TG.Thickness)
  â”œâ”€ Timestamp       (DateTime, ns=2;s=TG.Timestamp)
  â”œâ”€ Status          (UInt16, ns=2;s=TG.Status)
  â”œâ”€ Sequence        (UInt32, ns=2;s=TG.Sequence)
  â””â”€ ConnectionState (Boolean, ns=2;s=TG.Connected)
```

#### 4.4.2 å®‰å…¨ç­–ç•¥

```
Security Mode:    SignAndEncrypt (å¯é…ç½®ä¸º None/Sign/SignAndEncrypt)
Security Policy:  Basic256Sha256
User Auth:        Anonymous / Username+Password
Certificate:      è‡ªç­¾åè¯ä¹¦ (/opt/gw/cert/gateway.der)
```

### 4.5 Web é…ç½®æ¥å£ (webcfg)

#### 4.5.1 API ç«¯ç‚¹è®¾è®¡

```
GET  /api/status          â†’ ç³»ç»ŸçŠ¶æ€ (CPU/å†…å­˜/è¿è¡Œæ—¶é—´)
GET  /api/config          â†’ è·å–å½“å‰é…ç½®
POST /api/config          â†’ æ›´æ–°é…ç½® (60ç§’å›æ»šæœºåˆ¶)
POST /api/config/confirm  â†’ ç¡®è®¤é…ç½®ç”Ÿæ•ˆ
POST /api/restart         â†’ é‡å¯æœåŠ¡
GET  /api/logs?lines=100  â†’ è·å–æ—¥å¿—
POST /api/factory_reset   â†’ æ¢å¤å‡ºå‚è®¾ç½®
POST /api/firmware/upload â†’ å›ºä»¶ä¸Šä¼  (é¢„ç•™)
```

#### 4.5.2 é…ç½®æ–‡ä»¶ç»“æ„

```json
{
  "version": "2.0",
  "network": {
    "eth0": {
      "mode": "dhcp",
      "ip": "192.168.1.100",
      "netmask": "255.255.255.0",
      "gateway": "192.168.1.1"
    }
  },
  "rs485": {
    "device": "/dev/ttyUSB0",
    "baudrate": 19200,
    "poll_rate_ms": 20,
    "timeout_ms": 200,
    "retry_count": 3
  },
  "protocol": {
    "active": "modbus",
    "modbus": {
      "enabled": true,
      "listen_ip": "0.0.0.0",
      "port": 502,
      "slave_id": 1
    },
    "s7": {
      "enabled": false,
      "plc_ip": "192.168.1.10",
      "rack": 0,
      "slot": 1,
      "db_number": 10,
      "update_interval_ms": 50
    },
    "opcua": {
      "enabled": false,
      "server_url": "opc.tcp://192.168.1.20:4840",
      "security_mode": "None",
      "username": "",
      "password": ""
    }
  },
  "system": {
    "log_level": "INFO",
    "watchdog_timeout_s": 30,
    "data_retention_days": 7
  }
}
```

#### 4.5.3 è®¤è¯ä¸å®‰å…¨

```cpp
// HTTP Basic Authentication
const char* AUTH_USER = "admin";
const char* AUTH_PASS_HASH = "$2y$10$..."; // bcrypt hash

// HTTPS æ”¯æŒ (å¯é€‰)
mg_set_option(server, "ssl_certificate", "/opt/gw/cert/server.pem");
mg_set_option(server, "ssl_certificate_key", "/opt/gw/cert/server.key");
```

---

## äº”ã€è¿›ç¨‹é—´é€šä¿¡ (IPC) è®¾è®¡

### 5.1 å…±äº«å†…å­˜æ–¹æ¡ˆ

```cpp
// POSIX Shared Memory + Lock-Free Ring Buffer
#define SHM_NAME "/gw_data_ring"
#define RING_SIZE 1024  // ç¯å½¢ç¼“å†²åŒºå¤§å°

struct RingBuffer {
    std::atomic<uint32_t> write_idx;
    std::atomic<uint32_t> read_idx;
    NormalizedData data[RING_SIZE];
    
    // æ— é”å†™å…¥ (ç”Ÿäº§è€…: rs485d)
    void push(const NormalizedData& d) {
        uint32_t idx = write_idx.fetch_add(1, std::memory_order_relaxed) % RING_SIZE;
        data[idx] = d;
        std::atomic_thread_fence(std::memory_order_release);
    }
    
    // æ— é”è¯»å– (æ¶ˆè´¹è€…: modbusd/s7d/opcuad)
    bool pop_latest(NormalizedData& d) {
        uint32_t w = write_idx.load(std::memory_order_acquire);
        uint32_t r = read_idx.load(std::memory_order_relaxed);
        if (w == r) return false;
        
        uint32_t idx = (w - 1) % RING_SIZE;
        d = data[idx];
        read_idx.store(w, std::memory_order_release);
        return true;
    }
};
```

### 5.2 åˆ›å»ºä¸æ˜ å°„

```cpp
// åˆ›å»ºå…±äº«å†…å­˜ (rs485d å¯åŠ¨æ—¶)
int shm_fd = shm_open(SHM_NAME, O_CREAT | O_RDWR, 0666);
ftruncate(shm_fd, sizeof(RingBuffer));
RingBuffer* ring = (RingBuffer*)mmap(NULL, sizeof(RingBuffer),
                                      PROT_READ | PROT_WRITE,
                                      MAP_SHARED, shm_fd, 0);

// åˆå§‹åŒ–åŸå­å˜é‡
ring->write_idx.store(0);
ring->read_idx.store(0);
```

---

## å…­ã€å­˜å‚¨ä¸æ•°æ®ä¿æŠ¤

### 6.1 eMMC åˆ†åŒºè§„åˆ’

```
32GB eMMC åˆ†åŒºæ–¹æ¡ˆ:
â”œâ”€ /dev/mmcblk0p1   512MB   Boot åˆ†åŒº (ext4)
â”œâ”€ /dev/mmcblk0p2   20GB    Root åˆ†åŒº (ext4, åªè¯»æŒ‚è½½)
â”œâ”€ /dev/mmcblk0p3   2GB     Overlay åˆ†åŒº (ext4, è¯»å†™)
â”œâ”€ /dev/mmcblk0p4   8GB     Data åˆ†åŒº (ext4, /opt/gw)
â””â”€ /dev/mmcblk0p5   2GB     Backup åˆ†åŒº (é…ç½®å¤‡ä»½)
```

### 6.2 åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ

```bash
# /etc/fstab é…ç½®
/dev/mmcblk0p2  /          ext4  ro,noatime          0 0
/dev/mmcblk0p3  /overlay   ext4  rw,noatime          0 0
/dev/mmcblk0p4  /opt/gw    ext4  rw,noatime,sync     0 0

# OverlayFS æŒ‚è½½
mount -t overlay overlay -o \
    lowerdir=/,upperdir=/overlay/upper,workdir=/overlay/work \
    /overlay/merged
```

### 6.3 é…ç½®æ–‡ä»¶åŒå¤‡ä»½æœºåˆ¶

```cpp
// åŸå­å†™å…¥ + åŒå¤‡ä»½
bool save_config(const json& config) {
    const char* PRIMARY   = "/opt/gw/conf/config.json";
    const char* BACKUP    = "/mnt/backup/config.json";
    const char* TEMP      = "/opt/gw/conf/.config.tmp";
    
    // 1. å†™å…¥ä¸´æ—¶æ–‡ä»¶
    std::ofstream ofs(TEMP);
    ofs << config.dump(2);
    ofs.close();
    
    // 2. å¼ºåˆ¶è½ç›˜
    sync();
    
    // 3. åŸå­é‡å‘½å
    if (rename(TEMP, PRIMARY) != 0) return false;
    
    // 4. å¼‚æ­¥å¤‡ä»½
    std::thread([=]() {
        std::filesystem::copy_file(PRIMARY, BACKUP,
            std::filesystem::copy_options::overwrite_existing);
    }).detach();
    
    return true;
}
```

### 6.4 æ‰ç”µä¿æŠ¤

```cpp
// GPIO ç›‘æµ‹ç”µæºçŠ¶æ€ (éœ€ç¡¬ä»¶æ”¯æŒ)
#define POWER_GOOD_PIN 21

void power_monitor_thread() {
    struct gpiod_chip *chip = gpiod_chip_open("/dev/gpiochip0");
    struct gpiod_line *line = gpiod_chip_get_line(chip, POWER_GOOD_PIN);
    gpiod_line_request_input(line, "power-monitor");
    
    while (running) {
        if (gpiod_line_get_value(line) == 0) {
            // æ£€æµ‹åˆ°æ‰ç”µä¿¡å·
            syslog(LOG_CRIT, "Power failure detected! Emergency save...");
            save_config(current_config);
            sync();
            system("poweroff");
        }
        usleep(100000); // 100ms æ£€æŸ¥é—´éš”
    }
}
```

---

## ä¸ƒã€å®æ—¶æ€§ä¼˜åŒ–

### 7.1 å†…æ ¸å‚æ•°è°ƒä¼˜

```bash
# /etc/sysctl.d/99-gw-realtime.conf
# CPU è°ƒåº¦
kernel.sched_rt_runtime_us = -1              # ç¦ç”¨ RT é™åˆ¶
kernel.sched_migration_cost_ns = 5000000     # å‡å°‘è¿ç§»

# ç½‘ç»œä¼˜åŒ–
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_max_syn_backlog = 8096
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216

# å†…å­˜
vm.swappiness = 0                            # ç¦ç”¨äº¤æ¢åˆ†åŒº
vm.dirty_ratio = 10
vm.dirty_background_ratio = 5
```

### 7.2 è¿›ç¨‹ä¼˜å…ˆçº§é…ç½®

```ini
# /etc/systemd/system/gw-rs485d.service
[Service]
CPUAffinity=0                    # ç»‘å®šåˆ° CPU0
CPUSchedulingPolicy=fifo          # å®æ—¶è°ƒåº¦
CPUSchedulingPriority=90          # æœ€é«˜ä¼˜å…ˆçº§

Nice=-20                          # Nice å€¼
IOSchedulingClass=realtime
IOSchedulingPriority=0

LimitRTPRIO=95
LimitMEMLOCK=infinity
```

### 7.3 ä¸­æ–­äº²å’Œæ€§

```bash
#!/bin/bash
# å°† USB ä¸­æ–­ç»‘å®šåˆ° CPU3
USB_IRQ=$(grep ttyUSB /proc/interrupts | awk '{print $1}' | tr -d ':')
echo 8 > /proc/irq/$USB_IRQ/smp_affinity  # CPU3 (bitmask: 1000)

# ç½‘å¡ä¸­æ–­åˆ†é…
ETH0_IRQ=$(grep eth0 /proc/interrupts | awk '{print $1}' | tr -d ':')
echo 2 > /proc/irq/$ETH0_IRQ/smp_affinity # CPU1
```

---

## å…«ã€ç›‘æ§ä¸æ—¥å¿—

### 8.1 ç³»ç»Ÿçœ‹é—¨ç‹—

```cpp
// ä½¿ç”¨ Linux Watchdog Timer
#include <linux/watchdog.h>

int wdt_fd = open("/dev/watchdog", O_WRONLY);
int timeout = 30; // 30 ç§’è¶…æ—¶
ioctl(wdt_fd, WDIOC_SETTIMEOUT, &timeout);

// å–‚ç‹—çº¿ç¨‹
void watchdog_thread() {
    while (running) {
        ioctl(wdt_fd, WDIOC_KEEPALIVE, 0);
        
        // æ£€æŸ¥å…³é”®æœåŠ¡æ˜¯å¦å­˜æ´»
        if (!check_service_health("rs485d")) {
            syslog(LOG_ERR, "rs485d unhealthy! Triggering watchdog reset...");
            return; // ä¸å†å–‚ç‹—,è§¦å‘é‡å¯
        }
        
        sleep(10);
    }
}
```

### 8.2 æ—¥å¿—ç³»ç»Ÿ

```cpp
// ä½¿ç”¨ syslog + logrotate
openlog("gateway", LOG_PID | LOG_CONS, LOG_LOCAL0);

// æ—¥å¿—çº§åˆ«
#define LOG_TRACE   LOG_DEBUG
#define LOG_INFO    LOG_INFO
#define LOG_WARN    LOG_WARNING
#define LOG_ERROR   LOG_ERR
#define LOG_FATAL   LOG_CRIT

// ç»“æ„åŒ–æ—¥å¿—
void log_rs485_error(int error_code, const char* msg) {
    syslog(LOG_ERROR, "[RS485] code=%d, msg=%s, device=%s",
           error_code, msg, get_device_path());
}
```

```ini
# /etc/logrotate.d/gateway
/var/log/gateway/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root root
    sharedscripts
    postrotate
        systemctl reload rsyslog
    endscript
}
```

### 8.3 æ€§èƒ½ç›‘æ§

```cpp
// Prometheus Exporter (å¯é€‰)
class MetricsCollector {
    Counter rs485_read_count{"rs485_reads_total"};
    Counter rs485_error_count{"rs485_errors_total"};
    Histogram response_time{"protocol_response_seconds", {0.001, 0.01, 0.05}};
    Gauge active_connections{"active_connections"};
    
public:
    void record_rs485_read(bool success, double latency_ms) {
        rs485_read_count.Increment();
        if (!success) rs485_error_count.Increment();
        response_time.Observe(latency_ms / 1000.0);
    }
};

// HTTP ç«¯ç‚¹: GET /metrics
```

---

## ä¹ã€GPIO æ§åˆ¶ä¸ç”¨æˆ·äº¤äº’

### 9.1 æŒ‰é’®åŠŸèƒ½å®šä¹‰

| åŠ¨ä½œ | åŠŸèƒ½ | LED åé¦ˆ |
|------|------|---------|
| çŸ­æŒ‰ (< 1s) | åˆ‡æ¢åè®®æ¨¡å¼ | è“è‰²é—ªçƒ 3 æ¬¡ |
| é•¿æŒ‰ (3-5s) | ä¿å­˜å½“å‰é…ç½® | ç»¿è‰²å¸¸äº® 2 ç§’ |
| è¶…é•¿æŒ‰ (> 10s) | æ¢å¤å‡ºå‚è®¾ç½® | çº¢è‰²é—ªçƒ 5 æ¬¡ |

### 9.2 LED æŒ‡ç¤ºçŠ¶æ€

```
çº¢è‰² LED (æ•…éšœæŒ‡ç¤º):
  - ç†„ç­:       æ­£å¸¸è¿è¡Œ
  - æ…¢é—ª (1Hz): è½»å¾®é”™è¯¯ (RS-485 å¶å‘è¶…æ—¶)
  - å¿«é—ª (5Hz): ä¸¥é‡é”™è¯¯ (æœåŠ¡å´©æºƒ)
  - å¸¸äº®:       è‡´å‘½é”™è¯¯ (æ— æ³•å¯åŠ¨)

ç»¿è‰² LED (è¿è¡ŒæŒ‡ç¤º):
  - å‘¼å¸ç¯:     æ­£å¸¸è¿è¡Œ,æ— æ´»åŠ¨
  - å¸¸äº®:       é…ç½®ä¿å­˜æˆåŠŸ
  - ç†„ç­:       ç³»ç»Ÿæœªå°±ç»ª

è“è‰² LED (é€šä¿¡æŒ‡ç¤º):
  - é—ªçƒ:       æ­£åœ¨ä¼ è¾“æ•°æ®
  - å¸¸äº®:       åè®®è¿æ¥æˆåŠŸ
  - ç†„ç­:       åè®®æœªæ¿€æ´»
```

### 9.3 å®ç°ä»£ç 

```cpp
#include <gpiod.h>

class GPIOController {
    struct gpiod_chip *chip_;
    struct gpiod_line *btn_line_;
    struct gpiod_line *led_red_;
    struct gpiod_line *led_green_;
    struct gpiod_line *led_blue_;
    
public:
    void init() {
        chip_ = gpiod_chip_open_by_name("gpiochip0");
        btn_line_ = gpiod_chip_get_line(chip_, 17);
        led_red_ = gpiod_chip_get_line(chip_, 18);
        led_green_ = gpiod_chip_get_line(chip_, 19);
        led_blue_ = gpiod_chip_get_line(chip_, 20);
        
        gpiod_line_request_input(btn_line_, "button");
        gpiod_line_request_output(led_red_, "led-red", 0);
        gpiod_line_request_output(led_green_, "led-green", 0);
        gpiod_line_request_output(led_blue_, "led-blue", 0);
    }
    
    void button_handler_thread() {
        auto press_time = std::chrono::steady_clock::now();
        bool pressed = false;
        
        while (running) {
            int val = gpiod_line_get_value(btn_line_);
            
            if (val == 0 && !pressed) {
                pressed = true;
                press_time = std::chrono::steady_clock::now();
            }
            else if (val == 1 && pressed) {
                pressed = false;
                auto duration = std::chrono::steady_clock::now() - press_time;
                auto ms = std::chrono::duration_cast<std::chrono::milliseconds>(duration).count();
                
                if (ms < 1000) {
                    switch_protocol();      // çŸ­æŒ‰
                    blink_led(led_blue_, 3);
                }
                else if (ms < 5000) {
                    save_config();          // é•¿æŒ‰
                    set_led(led_green_, 1);
                    sleep(2);
                    set_led(led_green_, 0);
                }
                else {
                    factory_reset();        // è¶…é•¿æŒ‰
                    blink_led(led_red_, 5);
                }
            }
            
            usleep(10000); // 10ms è½®è¯¢
        }
    }
    
    void set_led(struct gpiod_line* led, int value) {
        gpiod_line_set_value(led, value);
    }
    
    void blink_led(struct gpiod_line* led, int count) {
        for (int i = 0; i < count; i++) {
            gpiod_line_set_value(led, 1);
            usleep(200000);
            gpiod_line_set_value(led, 0);
            usleep(200000);
        }
    }
};
```

---

## åã€å¼€å‘ç¯å¢ƒæ­å»º

### 10.1 Ubuntu 22.04 arm64 ç³»ç»Ÿå®‰è£…

```bash
# 1. ä¸‹è½½å®˜æ–¹é•œåƒ
wget http://download.friendlyarm.com/nanopiR5S/ubuntu-22.04-arm64.img.xz

# 2. çƒ§å½•åˆ° eMMC (ä½¿ç”¨ TF å¡å¯åŠ¨åæ‰§è¡Œ)
xzcat ubuntu-22.04-arm64.img.xz | dd of=/dev/mmcblk0 bs=4M status=progress
sync

# 3. é¦–æ¬¡å¯åŠ¨åé…ç½®
sudo apt update && sudo apt upgrade -y
sudo apt install build-essential cmake git wget curl
```

### 10.2 ä¾èµ–åº“å®‰è£…

```bash
# å®‰è£…æ‰€æœ‰ä¾èµ–
sudo apt install -y \
    libmodbus-dev \
    libgpiod-dev \
    libssl-dev \
    libjsoncpp-dev \
    libsqlite3-dev \
    pkg-config \
    screen \
    htop \
    iperf3

# ä»æºç ç¼–è¯‘ snap7
cd /tmp
git clone https://github.com/snap7/snap7.git
cd snap7/build/unix
make -f arm_v7_linux.mk all
sudo cp -r ../bin/arm_v7-linux/ /usr/local/lib/
sudo cp ../../src/sys/*.h /usr/local/include/
sudo ldconfig

# ä»æºç ç¼–è¯‘ open62541
cd /tmp
git clone https://github.com/open62541/open62541.git
cd open62541 && mkdir build && cd build
cmake -DBUILD_SHARED_LIBS=ON -DUA_ENABLE_ENCRYPTION=ON ..
make -j4
sudo make install
sudo ldconfig

# ä»æºç ç¼–è¯‘ civetweb
cd /tmp
git clone https://github.com/civetweb/civetweb.git
cd civetweb && mkdir build && cd build
cmake .. -DBUILD_SHARED_LIBS=OFF
make -j4
sudo make install
```

### 10.3 äº¤å‰ç¼–è¯‘ç¯å¢ƒ (å¯é€‰)

```bash
# åœ¨ x86 ä¸»æœºä¸Šå®‰è£…å·¥å…·é“¾
sudo apt install gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

# CMake toolchain æ–‡ä»¶
# toolchains/aarch64-linux.cmake
set(CMAKE_SYSTEM_NAME Linux)
set(CMAKE_SYSTEM_PROCESSOR aarch64)

set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)

set(CMAKE_FIND_ROOT_PATH /opt/aarch64-sysroot)
set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
```

---

## åä¸€ã€é¡¹ç›®ç›®å½•ç»“æ„

```
gateway/
â”œâ”€â”€ CMakeLists.txt
â”œâ”€â”€ README.md
â”œâ”€â”€ PROJECT_OVERVIEW.md         # æœ¬æ–‡æ¡£
â”œâ”€â”€ toolchains/
â”‚   â””â”€â”€ aarch64-linux.cmake
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”œâ”€â”€ logger.cpp/h        # æ—¥å¿—å°è£…
â”‚   â”‚   â”œâ”€â”€ config.cpp/h        # é…ç½®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ shm_ring.cpp/h      # å…±äº«å†…å­˜ç¯å½¢ç¼“å†²åŒº
â”‚   â”‚   â””â”€â”€ ndm.h               # æ•°æ®æ¨¡å‹å®šä¹‰
â”‚   â”œâ”€â”€ rs485d/
â”‚   â”‚   â”œâ”€â”€ main.cpp
â”‚   â”‚   â”œâ”€â”€ serial_port.cpp/h   # ä¸²å£æ“ä½œ
â”‚   â”‚   â”œâ”€â”€ protocol.cpp/h      # æµ‹åšä»ªåè®®è§£æ
â”‚   â”‚   â””â”€â”€ state_machine.cpp/h # çŠ¶æ€æœº
â”‚   â”œâ”€â”€ modbusd/
â”‚   â”‚   â”œâ”€â”€ main.cpp
â”‚   â”‚   â””â”€â”€ modbus_server.cpp/h
â”‚   â”œâ”€â”€ s7d/
â”‚   â”‚   â”œâ”€â”€ main.cpp
â”‚   â”‚   â””â”€â”€ s7_client.cpp/h
â”‚   â”œâ”€â”€ opcuad/
â”‚   â”‚   â”œâ”€â”€ main.cpp
â”‚   â”‚   â””â”€â”€ opcua_client.cpp/h
â”‚   â”œâ”€â”€ webcfg/
â”‚   â”‚   â”œâ”€â”€ main.cpp
â”‚   â”‚   â”œâ”€â”€ http_server.cpp/h
â”‚   â”‚   â””â”€â”€ static/             # Web é™æ€æ–‡ä»¶
â”‚   â”‚       â”œâ”€â”€ index.html
â”‚   â”‚       â”œâ”€â”€ app.js
â”‚   â”‚       â””â”€â”€ style.css
â”‚   â”œâ”€â”€ gpioctl/
â”‚   â”‚   â”œâ”€â”€ main.cpp
â”‚   â”‚   â”œâ”€â”€ button.cpp/h
â”‚   â”‚   â””â”€â”€ led.cpp/h
â”‚   â””â”€â”€ watchdog/
â”‚       â””â”€â”€ main.cpp
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ build.sh                # ç¼–è¯‘è„šæœ¬
â”‚   â”œâ”€â”€ deploy.sh               # éƒ¨ç½²è„šæœ¬
â”‚   â”œâ”€â”€ setup_env.sh            # ç¯å¢ƒé…ç½®
â”‚   â”œâ”€â”€ benchmark.sh            # æ€§èƒ½æµ‹è¯•
â”‚   â””â”€â”€ install_service.sh      # systemd æœåŠ¡å®‰è£…
â”œâ”€â”€ systemd/
â”‚   â”œâ”€â”€ gw-rs485d.service
â”‚   â”œâ”€â”€ gw-modbusd.service
â”‚   â”œâ”€â”€ gw-s7d.service
â”‚   â”œâ”€â”€ gw-opcuad.service
â”‚   â”œâ”€â”€ gw-webcfg.service
â”‚   â”œâ”€â”€ gw-gpioctl.service
â”‚   â””â”€â”€ gw-watchdog.service
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ config.json.template    # é…ç½®æ¨¡æ¿
â”‚   â””â”€â”€ sysctl.d/
â”‚       â””â”€â”€ 99-gw-realtime.conf
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â”œâ”€â”€ test_shm.cpp
â”‚   â”‚   â”œâ”€â”€ test_protocol.cpp
â”‚   â”‚   â””â”€â”€ test_config.cpp
â”‚   â”œâ”€â”€ integration/
â”‚   â”‚   â”œâ”€â”€ test_modbus_client.py
â”‚   â”‚   â””â”€â”€ test_s7_loopback.cpp
â”‚   â””â”€â”€ stress/
â”‚       â””â”€â”€ modbus_tps_bench.cpp
â””â”€â”€ docs/
    â”œâ”€â”€ API.md                  # Web API æ–‡æ¡£
    â”œâ”€â”€ PROTOCOL.md             # åè®®é€‚é…æ‰‹å†Œ
    â”œâ”€â”€ DEPLOYMENT.md           # éƒ¨ç½²æŒ‡å—
    â””â”€â”€ TROUBLESHOOTING.md      # æ•…éšœæ’æŸ¥
```

---

## åäºŒã€å¼€å‘è·¯çº¿å›¾

### é˜¶æ®µ 0: ç¯å¢ƒå‡†å¤‡ (1 å‘¨)

- [x] è´­ä¹° NanoPi R5S (2GB+32GB eMMC)
- [x] å®‰è£… Ubuntu 22.04 arm64
- [x] é…ç½®ç½‘ç»œã€SSHã€å¼€å‘å·¥å…·
- [x] å®‰è£…æ‰€æœ‰ä¾èµ–åº“
- [x] æ­å»º Git ä»“åº“ä¸é¡¹ç›®ç»“æ„

### é˜¶æ®µ 1: æ ¸å¿ƒæ¨¡å—å¼€å‘ (3 å‘¨)

**Week 1: æ•°æ®é‡‡é›†å±‚**
```
- [ ] å®ç°å…±äº«å†…å­˜ç¯å½¢ç¼“å†²åŒº (lock-free)
- [ ] å®ç° RS-485 ä¸²å£æ“ä½œå°è£…
- [ ] å®ç°æµ‹åšä»ªåè®®è§£æ (å‡è®¾ Modbus RTU)
- [ ] å®ç°çŠ¶æ€æœºä¸å¼‚å¸¸å¤„ç†
- [ ] å•å…ƒæµ‹è¯•: 100k æ¬¡è¯»å†™æ— ä¸¢å¤±
```

**Week 2: åè®®è½¬æ¢å±‚**
```
- [ ] å®ç° Modbus TCP ä»ç«™ (libmodbus)
- [ ] å®ç° S7 å®¢æˆ·ç«¯ (snap7)
- [ ] å®ç°æ•°æ®æ˜ å°„ä¸å­—èŠ‚åºè½¬æ¢
- [ ] é›†æˆæµ‹è¯•: æ¨¡æ‹Ÿ PLC è¿æ¥
```

**Week 3: é…ç½®ä¸ Web ç•Œé¢**
```
- [ ] å®ç°é…ç½®æ–‡ä»¶åŠ è½½/ä¿å­˜ (JSON)
- [ ] å®ç° Web HTTP æœåŠ¡å™¨ (civetweb)
- [ ] å®ç° RESTful API (CRUD)
- [ ] å‰ç«¯é¡µé¢: Bootstrap + jQuery
- [ ] 60ç§’å›æ»šæœºåˆ¶éªŒè¯
```

### é˜¶æ®µ 2: ç³»ç»Ÿé›†æˆä¸ä¼˜åŒ– (2 å‘¨)

**Week 4: å¤šè¿›ç¨‹æ¶æ„**
```
- [ ] ç¼–å†™æ‰€æœ‰ systemd æœåŠ¡æ–‡ä»¶
- [ ] å®ç°è¿›ç¨‹é—´é€šä¿¡æµ‹è¯•
- [ ] å®ç° GPIO æŒ‰é’®/LED æ§åˆ¶
- [ ] å®ç°çœ‹é—¨ç‹—å®ˆæŠ¤è¿›ç¨‹
- [ ] å‹åŠ›æµ‹è¯•: 24å°æ—¶ç¨³å®šè¿è¡Œ
```

**Week 5: æ€§èƒ½è°ƒä¼˜**
```
- [ ] CPU äº²å’Œæ€§ç»‘å®š
- [ ] å†…æ ¸å‚æ•°è°ƒä¼˜
- [ ] å®æ—¶è°ƒåº¦ç­–ç•¥é…ç½®
- [ ] åŸºå‡†æµ‹è¯•: Modbus TPS, å“åº”å»¶è¿Ÿ
- [ ] å†…å­˜æ³„æ¼æ£€æµ‹ (valgrind)
```

### é˜¶æ®µ 3: ç°åœºéªŒè¯ä¸äº¤ä»˜ (2 å‘¨)

**Week 6: å¯é æ€§æµ‹è¯•**
```
- [ ] æ–­ç”µæ¢å¤æµ‹è¯• (æ‹”æ’ç”µæº)
- [ ] ç½‘ç»œæŠ–åŠ¨æµ‹è¯• (æ‹”ç½‘çº¿)
- [ ] åè®®åˆ‡æ¢æµ‹è¯• (å¿«é€Ÿåˆ‡æ¢)
- [ ] EMC æµ‹è¯• (é™ç”µ/æµªæ¶Œ)
- [ ] æ¸©åº¦æµ‹è¯• (0-70Â°C)
```

**Week 7: æ–‡æ¡£ä¸äº¤ä»˜**
```
- [ ] å®Œæˆç”¨æˆ·æ‰‹å†Œ
- [ ] å®Œæˆå¼€å‘æ–‡æ¡£
- [ ] å®Œæˆéƒ¨ç½²è„šæœ¬
- [ ] æ‰“åŒ…å›ºä»¶é•œåƒ
- [ ] ç°åœºå®‰è£…ä¸åŸ¹è®­
```

**Week 8: é•¿ç¨³éªŒæ”¶**
```
- [ ] ç°åœºè¿ç»­è¿è¡Œ 7Ã—24 å°æ—¶
- [ ] æ€§èƒ½æŒ‡æ ‡éªŒæ”¶
- [ ] é—®é¢˜ä¿®å¤ä¸ä¼˜åŒ–
- [ ] æ­£å¼äº¤ä»˜
```

---

## åä¸‰ã€æ€§èƒ½åŸºå‡†ä¸éªŒæ”¶æ ‡å‡†

### 13.1 åŠŸèƒ½æ€§æŒ‡æ ‡

| æµ‹è¯•é¡¹ | éªŒæ”¶æ ‡å‡† | æµ‹è¯•æ–¹æ³• |
|--------|---------|----------|
| RS-485 é‡‡æ ·ç‡ | 50Hz Â± 1Hz | 1å°æ—¶è¿ç»­è®°å½•,ç»Ÿè®¡é¢‘ç‡ |
| Modbus å“åº”æ—¶é—´ | P99 < 10ms | 1ä¸‡æ¬¡æŸ¥è¯¢ç»Ÿè®¡ |
| S7 å†™å‘¨æœŸ | 50ms Â± 5ms | ç¤ºæ³¢å™¨æµ‹é‡ |
| Web å“åº”æ—¶é—´ | P99 < 50ms | ApacheBench å‹æµ‹ |
| é…ç½®ä¿å­˜æ—¶é—´ | < 100ms | è®¡æ—¶å™¨æµ‹é‡ |
| ç³»ç»Ÿå¯åŠ¨æ—¶é—´ | < 15s | Bootchart åˆ†æ |

### 13.2 å¯é æ€§æŒ‡æ ‡

| æµ‹è¯•é¡¹ | éªŒæ”¶æ ‡å‡† | æµ‹è¯•æ–¹æ³• |
|--------|---------|----------|
| è¿ç»­è¿è¡Œæ—¶é—´ | > 168 å°æ—¶ (7å¤©) | ç°åœºå®æµ‹ |
| å†…å­˜å ç”¨ | < 500MB | top/htop ç›‘æ§ |
| å†…å­˜æ³„æ¼ | 0 byte/hour | valgrind --leak-check=full |
| CPU å ç”¨ | < 50% (4æ ¸å¹³å‡) | mpstat 1 3600 |
| æ‰ç”µæ•°æ®ä¸¢å¤± | 0 æ¡ | æ–­ç”µ 100 æ¬¡æµ‹è¯• |
| é…ç½®æŸåç‡ | 0% | å¼‚å¸¸æ–­ç”µ 50 æ¬¡ |

### 13.3 æ€§èƒ½å‹æµ‹

```bash
# Modbus TCP ååé‡æµ‹è¯•
./modbus_tps_bench --host 192.168.1.100 --duration 60

# Web API å‹æµ‹
ab -n 10000 -c 50 http://192.168.1.100:8080/api/status

# ç½‘ç»œå¸¦å®½æµ‹è¯•
iperf3 -c 192.168.1.100 -t 300 -P 10
```

---

## åå››ã€æ•…éšœæ’æŸ¥æŒ‡å—

### 14.1 å¸¸è§é—®é¢˜

| ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|---------|----------|
| RS-485 æ— æ•°æ® | USB è®¾å¤‡æœªè¯†åˆ« | `dmesg | grep ttyUSB`,æ£€æŸ¥è®¾å¤‡èŠ‚ç‚¹ |
| Modbus è¿æ¥å¤±è´¥ | é˜²ç«å¢™é˜»æ­¢ 502 ç«¯å£ | `sudo ufw allow 502/tcp` |
| S7 è¿æ¥è¶…æ—¶ | PLC IP é”™è¯¯æˆ– Slot é…ç½®é”™ | ç”¨ snap7 å·¥å…·æµ‹è¯•è¿æ¥ |
| Web ç•Œé¢æ— å“åº” | webcfg æœåŠ¡æœªå¯åŠ¨ | `systemctl status gw-webcfg` |
| LED ä¸äº® | GPIO æƒé™é—®é¢˜ | å°†ç”¨æˆ·åŠ å…¥ `gpio` ç»„ |
| ç³»ç»Ÿå¡æ­» | çœ‹é—¨ç‹—è¶…æ—¶ | æ£€æŸ¥ `/var/log/syslog` |

### 14.2 è°ƒè¯•å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
systemctl status gw-*

# å®æ—¶æ—¥å¿—
journalctl -u gw-rs485d -f

# æŸ¥çœ‹å…±äº«å†…å­˜
ipcs -m

# ä¸²å£è°ƒè¯•
screen /dev/ttyUSB0 19200

# ç½‘ç»œæŠ“åŒ…
tcpdump -i eth0 port 502 -w modbus.pcap

# CPU äº²å’Œæ€§æ£€æŸ¥
ps -eo pid,comm,psr | grep gw-

# æ€§èƒ½åˆ†æ
perf record -a -g -- sleep 10
perf report
```

---

## åäº”ã€æ‰©å±•è§„åˆ’

### 15.1 çŸ­æœŸæ‰©å±• (3 ä¸ªæœˆå†…)

- [ ] **MQTT å®¢æˆ·ç«¯**: æ”¯æŒç‰©è”ç½‘å¹³å°ä¸ŠæŠ¥
- [ ] **æ•°æ®è®°å½•**: å†™å…¥ SQLite æ•°æ®åº“,æ”¯æŒå†å²æŸ¥è¯¢
- [ ] **å‘Šè­¦æ¨é€**: å¾®ä¿¡/é‚®ä»¶å‘Šè­¦
- [ ] **OPC UA æœåŠ¡å™¨æ¨¡å¼**: ä¸ä»…ä½œä¸ºå®¢æˆ·ç«¯,ä¹Ÿå¯ä½œä¸ºæœåŠ¡å™¨

### 15.2 ä¸­æœŸæ‰©å±• (6 ä¸ªæœˆå†…)

- [ ] **å¤šé€šé“æ‰©å±•**: æ”¯æŒ 4 è·¯ RS-485 åŒæ—¶é‡‡é›†
- [ ] **è§†è§‰è¯†åˆ«**: æ¥å…¥æ‘„åƒå¤´åšè¡¨é¢ç¼ºé™·æ£€æµ‹
- [ ] **è¾¹ç¼˜è®¡ç®—**: é›†æˆ TensorFlow Lite åšæœ¬åœ°æ¨ç†
- [ ] **4G/5G æ¨¡å—**: æ”¯æŒæ— çº¿è”ç½‘

### 15.3 é•¿æœŸè§„åˆ’ (1 å¹´å†…)

- [ ] **äº‘å¹³å°å¯¹æ¥**: é˜¿é‡Œäº‘/AWS IoT Core
- [ ] **æ•°å­—å­ªç”Ÿ**: 3D å¯è§†åŒ–æœºåºŠçŠ¶æ€
- [ ] **é¢„æµ‹æ€§ç»´æŠ¤**: åŸºäºå†å²æ•°æ®çš„æ•…éšœé¢„æµ‹
- [ ] **è½¦é—´çº§è”ç½‘**: å¤šå°ç½‘å…³ç»„ç½‘,ç»Ÿä¸€ç®¡ç†å¹³å°

---

## åå…­ã€äº¤ä»˜æ¸…å•

### 16.1 è½¯ä»¶äº¤ä»˜

- âœ… å®Œæ•´æºä»£ç  (Git ä»“åº“)
- âœ… ç¼–è¯‘è„šæœ¬ä¸ Makefile
- âœ… systemd æœåŠ¡é…ç½®æ–‡ä»¶
- âœ… é…ç½®æ–‡ä»¶æ¨¡æ¿
- âœ… æ€§èƒ½æµ‹è¯•è„šæœ¬
- âœ… éƒ¨ç½²è‡ªåŠ¨åŒ–è„šæœ¬

### 16.2 æ–‡æ¡£äº¤ä»˜

- âœ… é¡¹ç›®æŠ€æœ¯æ–¹æ¡ˆ (æœ¬æ–‡æ¡£)
- âœ… API æ¥å£æ–‡æ¡£
- âœ… åè®®é€‚é…æ‰‹å†Œ
- âœ… éƒ¨ç½²å®‰è£…æŒ‡å—
- âœ… ç”¨æˆ·æ“ä½œæ‰‹å†Œ
- âœ… æ•…éšœæ’æŸ¥æ‰‹å†Œ

### 16.3 å›ºä»¶äº¤ä»˜

- âœ… Ubuntu 22.04 arm64 å®šåˆ¶é•œåƒ (.img.xz)
- âœ… é¢„è£…æ‰€æœ‰ä¾èµ–åº“
- âœ… é¢„é…ç½®ç½‘ç»œä¸æœåŠ¡
- âœ… çƒ§å½•å·¥å…·ä¸è¯´æ˜

### 16.4 ç¡¬ä»¶æ¸…å•

| ç‰©æ–™ | å‹å· | æ•°é‡ | å¤‡æ³¨ |
|------|------|------|------|
| ä¸»æ§æ¿ | NanoPi R5S 2GB+32GB | 1 | FriendlyElec |
| USB-RS485 | CH340G å·¥ä¸šçº§ | 1 | è‡ªåŠ¨æ–¹å‘æ§åˆ¶ |
| ç”µæºæ¨¡å— | DC 9-36V â†’ 5V/3A | 1 | å®½å‹è¾“å…¥ |
| é‡‘å±å¤–å£³ | é“åˆé‡‘æ•£çƒ­å£³ | 1 | å¸¦ DIN å¯¼è½¨å¡æ‰£ |
| æŒ‰é’® | 6mm è‡ªé”æŒ‰é’® | 1 | é˜²æ°´ IP65 |
| LED æŒ‡ç¤ºç¯ | 5mm çº¢/ç»¿/è“ | 3 | å…±é˜´æ |

---

## åä¸ƒã€é¡¹ç›®ç‰¹è‰²æ€»ç»“

### 17.1 æŠ€æœ¯äº®ç‚¹

- âœ… **çº¯ C++ å®ç°**: ç»Ÿä¸€æŠ€æœ¯æ ˆ,æ—  Python/Java ä¾èµ–
- âœ… **æ— é”å¹¶å‘**: Lock-Free Ring Buffer,é›¶æ‹·è´æ•°æ®ä¼ é€’
- âœ… **å®æ—¶æ€§ä¿è¯**: FIFO è°ƒåº¦ + CPU ç»‘æ ¸ + ä¸­æ–­äº²å’Œ
- âœ… **é«˜å¯é æ€§**: åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿ + çœ‹é—¨ç‹— + åŒå¤‡ä»½
- âœ… **æ˜“ç»´æŠ¤æ€§**: Web é…ç½® + 60ç§’å›æ»š + è¿œç¨‹å‡çº§

### 17.2 å¯¹æ¯”ä¼ ç»Ÿæ–¹æ¡ˆ

| å¯¹æ¯”é¡¹ | ä¼ ç»Ÿ STM32 æ–¹æ¡ˆ | æœ¬æ–¹æ¡ˆ (R5S + Linux) |
|--------|----------------|----------------------|
| å¼€å‘å‘¨æœŸ | 3-6 ä¸ªæœˆ | 2-3 ä¸ªæœˆ |
| åè®®æ‰©å±• | éœ€é‡æ–°çƒ§å½• | è½¯ä»¶é…ç½®åˆ‡æ¢ |
| è¿œç¨‹ç»´æŠ¤ | ä¸æ”¯æŒ | SSH/Web è¿œç¨‹ç®¡ç† |
| è®¡ç®—æ€§èƒ½ | 480MHz å•æ ¸ | 2.0GHz å››æ ¸ (4å€+) |
| å­˜å‚¨å®¹é‡ | 2MB Flash | 32GB eMMC (16000å€) |
| OTA å‡çº§ | éœ€ä¸“ç”¨å·¥å…· | æ ‡å‡† HTTP/TFTP |
| è°ƒè¯•ä¾¿åˆ©æ€§ | JTAG/SWD | GDB/perf/Wireshark |

---

## åå…«ã€æ€»ç»“ä¸ä¸‹ä¸€æ­¥

æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„**å·¥ä¸šæœºåºŠæ•°æ®é‡‡é›†ç½‘å…³**æŠ€æœ¯æ–¹æ¡ˆ,åŸºäº **NanoPi R5S (2GB+32GB eMMC)** ç¡¬ä»¶å¹³å°å’Œ **Ubuntu 22.04 arm64** å¼€å‘ç¯å¢ƒ,é‡‡ç”¨**çº¯ C++ æŠ€æœ¯æ ˆ**ã€‚

æ–¹æ¡ˆç‰¹ç‚¹:
- ğŸ“Œ **æ€§èƒ½æŒ‡æ ‡**: 50Hz é‡‡æ · + 3000 TPS Modbus + < 10ms å“åº”
- ğŸ“Œ **å¯é æ€§**: 7Ã—24 è¿è¡Œ + æ‰ç”µä¿æŠ¤ + çœ‹é—¨ç‹—
- ğŸ“Œ **æ˜“ç»´æŠ¤**: Web é…ç½® + è‡ªåŠ¨å›æ»š + æ—¥å¿—ç›‘æ§
- ğŸ“Œ **å¯æ‰©å±•**: æ¨¡å—åŒ–æ¶æ„,æ”¯æŒæœªæ¥åè®®æ‰©å±•

### å»ºè®®ä¸‹ä¸€æ­¥è¡ŒåŠ¨:

1. **ç«‹å³å¯åŠ¨**: æŒ‰ç…§ç¬¬ 10 èŠ‚æ­å»ºå¼€å‘ç¯å¢ƒ
2. **è·å–ç¡¬ä»¶**: è´­ä¹° NanoPi R5S + USB-RS485 è½¬æ¢å™¨
3. **ç¡®è®¤åè®®**: ä¸æµ‹åšä»ªå‚å•†ç¡®è®¤é€šä¿¡åè®®ç»†èŠ‚
4. **å¼€å§‹ç¼–ç **: æŒ‰ç…§ç¬¬ 12 èŠ‚è·¯çº¿å›¾åˆ†é˜¶æ®µå®æ–½

---

**éœ€è¦æˆ‘ç»§ç»­ç”Ÿæˆçš„å†…å®¹:**
- [ ] CMake å·¥ç¨‹æ¨¡æ¿ + ç¼–è¯‘è„šæœ¬
- [ ] systemd æœåŠ¡æ–‡ä»¶å®Œæ•´ç‰ˆ
- [ ] æ€§èƒ½æµ‹è¯•è„šæœ¬å¥—ä»¶
- [ ] Web å‰ç«¯é¡µé¢ä»£ç 
- [ ] åè®®é€‚é…æ‰‹å†Œ (Modbus/S7/OPC UA)

è¯·å‘Šè¯‰æˆ‘ä½ å¸Œæœ›ä¼˜å…ˆè·å¾—å“ªéƒ¨åˆ†å®ç°ä»£ç ! ğŸš€